<!DOCTYPE HTML>
<html>
<!--
Copyright (c) 2012 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->
<head>
<script src="/src/base.js"></script>
<script>
  base.require('base.unittest');
  base.require('base.bbox2');
  base.require('base.quad');
  base.require('ui.quad_view');
  base.require('ui.quad_view_viewport');
</script>
<link rel="shortcut icon" href="data:image/x-icon;base64," type="image/x-icon">
</head>
<body>
<script>
    'use strict';

    var Quad = base.Quad;
    var QuadFromXYWH = base.QuadFromXYWH;

    var QuadView = ui.QuadView;
    var QuadViewViewport = ui.QuadViewViewport;

    function testInstantiate() {
      var quadView = new QuadView();
      // Something causes this to go crazy in an iframe.
      if (window == window.top)
        this.addHTMLOutput(undefined, quadView);

      var quads = [
        QuadFromXYWH(0, 0, 10, 10),
        QuadFromXYWH(10, 10, 10, 10),
        QuadFromXYWH(20, 4, 10, 10),
        QuadFromXYWH(30, 10, 20, 20),
        QuadFromXYWH(20, 20, 10, 10),
        QuadFromXYWH(15, 15, 10, 10)
        ];
      quads[2].selected = true;
      quads[3].backgroundColor = 'rgba(255,0,255,0.15)';
      quads[3].borderColor = 'rgba(0,255,255,1)';
      var quadsBBox = new base.BBox2();
      for (var i = 0; i < quads.length; i++)
        quadsBBox.addQuad(quads[i]);

      quadView.title = 'Test Tree';
      quadView.quads = quads;
      quadView.viewport = new QuadViewViewport(quadsBBox, 10.0);
      quadView.deviceViewportSizeForFrame = {widht: 50,
                                             height: 30};
    }

    function testBackgroundTexture() {
      var quadView = new QuadView();
      // Something causes this to go crazy in an iframe.
      if (window == window.top)
        this.addHTMLOutput(undefined, quadView);

      var quads = [
        QuadFromXYWH(0, 0, 10, 10),
        ];
      var data = new Uint8Array(2*2*4);
      data[0] = 0;
      data[1] = 0;
      data[2] = 0;
      data[3] = 255;

      data[4] = 255;
      data[5] = 0;
      data[6] = 0;
      data[7] = 255;

      data[8] = 0;
      data[9] = 255;
      data[10] = 0;
      data[11] = 255;

      data[12] = 0;
      data[13] = 0;
      data[14] = 255;
      data[15] = 255;
      quads[0].backgroundRasterData = {
        data: data,
        width: 2,
        height: 2
      };
      var quadsBBox = new base.BBox2();
      for (var i = 0; i < quads.length; i++)
        quadsBBox.addQuad(quads[i]);

      quadView.title = 'Test Tree';
      quadView.quads = quads;
      quadView.viewport = new QuadViewViewport(quadsBBox, 50.0);
    }

    function testWarpedTexturedQuad() {
      var quadView = new QuadView();
      // Something causes this to go crazy in an iframe.
      if (window == window.top)
        this.addHTMLOutput(undefined, quadView);

      var quads = [
        base.QuadFrom8Array([0, 0,
                        10, 0,
                        10, 5,
                        0, 10]),
        ];
      var data = new Uint8Array(2*2*4);
      data[0] = 0;
      data[1] = 0;
      data[2] = 0;
      data[3] = 255;

      data[4] = 255;
      data[5] = 0;
      data[6] = 0;
      data[7] = 255;

      data[8] = 0;
      data[9] = 255;
      data[10] = 0;
      data[11] = 255;

      data[12] = 0;
      data[13] = 0;
      data[14] = 255;
      data[15] = 255;
      quads[0].backgroundRasterData = {
        data: data,
        width: 2,
        height: 2
      };
      var quadsBBox = new base.BBox2();
      for (var i = 0; i < quads.length; i++)
        quadsBBox.addQuad(quads[i]);

      quadView.title = 'Test Tree';
      quadView.quads = quads;
      quadView.viewport = new QuadViewViewport(quadsBBox, 50.0);
    }

    function testFindTiles() {
      var quadView = new QuadView();

      var quads = [
        QuadFromXYWH(0, 0, 10, 10),
        QuadFromXYWH(10, 10, 10, 10),
        QuadFromXYWH(20, 4, 10, 10),
        QuadFromXYWH(30, 10, 20, 20),
        QuadFromXYWH(20, 20, 10, 10),
        QuadFromXYWH(15, 15, 10, 10)
        ];
      var quadsBBox = new base.BBox2();
      for (var i = 0; i < quads.length; i++)
        quadsBBox.addQuad(quads[i]);

      quadView.title = 'Test Tree';
      quadView.quads = quads;
      quadView.viewport = new QuadViewViewport(quadsBBox, 10.0, true, 2);
      quadView.deviceViewportSizeForFrame = {widht: 50,
                                             height: 30};

      document.body.appendChild(quadView);
      try {
        var rect = quadView.canvas_.getBoundingClientRect();
        var hitIndices = quadView.findQuadsAtCanvasClientPoint(rect.left + 75,
                                                               rect.top + 75);
      } finally {
        document.body.removeChild(quadView);
      }

      assertEquals(2, hitIndices.length);
      assertArrayEquals(hitIndices, [1, 5]);
    }

</script>
</body>
</html>
