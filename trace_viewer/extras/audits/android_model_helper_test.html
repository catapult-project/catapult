<!DOCTYPE html>
<!--
Copyright (c) 2015 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/core/test_utils.html">
<link rel="import" href="/extras/audits/android_auditor.html">
<link rel="import" href="/extras/importer/linux_perf/linux_perf_importer.html">

<script>
'use strict';

tv.b.unittest.testSuite(function() {
  var AndroidModelHelper = tv.e.audits.AndroidModelHelper;
  var TraceModel = tv.c.TraceModel;
  var newAsyncSliceNamed = tv.c.test_utils.newAsyncSliceNamed;
  var newSliceNamed = tv.c.test_utils.newSliceNamed;

  /*
   * List of customizeModelCallbacks which produce different 80ms frames,
   * each starting at 10ms, and with a single important slice
   */
  var SINGLE_FRAME_CUSTOM_MODELS = [
    function(model) {
      // UI thread only
      var uiThread = model.getOrCreateProcess(120).getOrCreateThread(120);
      uiThread.sliceGroup.pushSlice(newSliceNamed('performTraversals', 10, 80));

      model.uiThread = uiThread;
    },

    function(model) {
      // RenderThread only
      var renderThread = model.getOrCreateProcess(120).getOrCreateThread(200);
      renderThread.name = 'RenderThread';
      renderThread.sliceGroup.pushSlice(newSliceNamed('doFrame', 10, 80));

      model.renderThread = renderThread;
    },

    function(model) {
      var uiThread = model.getOrCreateProcess(120).getOrCreateThread(120);

      // UI thread time - 20 (from 0 to 20)
      uiThread.asyncSliceGroup.push(
        newAsyncSliceNamed('deliverInputEvent', 0, 9, uiThread, uiThread));
      uiThread.sliceGroup.pushSlice(newSliceNamed('performTraversals', 10, 10));
      uiThread.sliceGroup.pushSlice(newSliceNamed('draw', 10, 8));
      uiThread.sliceGroup.pushSlice(newSliceNamed('Record View#draw()', 10, 8));

      // RenderThread time - 61 (from 19 to 80), but minus 1 from total for sync
      var renderThread = model.getOrCreateProcess(120).getOrCreateThread(200);
      renderThread.name = 'RenderThread';
      renderThread.sliceGroup.pushSlice(newSliceNamed('DrawFrame', 19, 71));
      renderThread.sliceGroup.pushSlice(newSliceNamed('syncFrameState', 19, 1));

      model.uiThread = uiThread;
      model.renderThread = renderThread;
    }
  ];

  test('getThreads', function() {
    SINGLE_FRAME_CUSTOM_MODELS.forEach(function(customizeModelCallback) {
      var model = tv.c.test_utils.newModel(customizeModelCallback);
      var helper = new AndroidModelHelper(model);
      assert.equal(model.uiThread, helper.apps[0].uiThread);
      assert.equal(model.renderThread, helper.apps[0].renderThread);
    });
  });

  test('getFrames', function() {
    SINGLE_FRAME_CUSTOM_MODELS.forEach(function(customizeModelCallback) {
      var model = tv.c.test_utils.newModel(customizeModelCallback);
      var helper = new AndroidModelHelper(model);
      assert.equal(1, helper.apps.length);

      var frames = helper.apps[0].getFrames();
      assert.equal(frames.length, 1);
      assert.closeTo(frames[0].totalDuration, 80, 1e-5);

      assert.closeTo(frames[0].start, 10, 1e-5);
      assert.closeTo(frames[0].end, 90, 1e-5);
    });
  });

  test('iterateImportantSlices', function() {
    SINGLE_FRAME_CUSTOM_MODELS.forEach(function(customizeModelCallback) {
      var model = tv.c.test_utils.newModel(customizeModelCallback);
      var helper = new AndroidModelHelper(model);

      var seen = 0;
      helper.iterateImportantSlices(function(importantSlice) {
        assert.isTrue(importantSlice instanceof tv.c.trace_model.Slice);
        seen++;
      });
      assert.equal(seen, 1);
    });
  });
});
</script>
